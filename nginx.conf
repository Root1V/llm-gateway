events {
    worker_connections 1024;
}

http {
    include mime.types;
    charset utf-8;

    log_format gateway '$remote_addr - $remote_user [$time_local] "$request" '
                       '$status $body_bytes_sent "$http_referer" "$http_user_agent" '
                       'upstream=$upstream_addr upstream_status=$upstream_status '
                       'upstream_time=$upstream_response_time request_time=$request_time';

    access_log /var/log/nginx/access.log gateway;
    error_log  /var/log/nginx/error.log warn;

    # --------------------
    # TOKEN EXTRACTION
    # --------------------

    # Token desde Authorization header (API)
    map $http_authorization $llm_token {
        default "";
        "~^Bearer\s+(.*)$" $1;
        "~^(.*)$" $1;
    }

    # Token desde cookie (Web)
    map $cookie_auth_token $web_token {
        default "";
        "~^(.*)$" $1;
    }

    # Detectar si es petición del SDK
    map $http_user_agent $is_sdk {
        default 0;
        "~Architecture-PE/LLM-Client" 1;
        "~OpenAI/Python" 1;
    }

    server {
        listen 80;

        # --------------------
        # AUTH INTERNAL
        # --------------------

        location = /_auth {
            internal;

            proxy_method POST;
            proxy_set_body '{"token":"$auth_token"}';
            proxy_set_header Content-Type application/json;

            proxy_pass http://host.docker.internal:9900/validate;
        }

        # --------------------
        # LOGIN PAGE
        # --------------------

        location = /login {
            root /usr/share/nginx/html;
            index login.html;
            try_files /login.html =404;
        }

        location = /logout {
            root /usr/share/nginx/html;
            index logout.html;
            try_files /logout.html =404;
        }

        location /styles.css {
            auth_basic off;
            root /usr/share/nginx/html;
        }

        location /login.js {
            auth_basic off;
            root /usr/share/nginx/html;
        }

        location /logout.css {
            auth_basic off;
            root /usr/share/nginx/html;
        }

        location /auth/login {
            proxy_pass http://host.docker.internal:9900/login;
            proxy_set_header Host $host;
        }

        # --------------------
        # WEB UI (VISIBLE)
        # --------------------

        location / {
            set $auth_token $web_token;
            auth_request /_auth;
            error_page 401 = @error_handler;

            proxy_pass http://host.docker.internal:9090/;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # --------------------
        # API / LLM
        # --------------------

        location /llm/login {
            proxy_pass http://host.docker.internal:9900/llm/login;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # --------------------
        # API CONSUME WEB CHAT
        # --------------------

        location /v1/chat/completions {
            set $auth_token $web_token;
    
            auth_request /_auth;
            error_page 401 = @error401;

            proxy_pass http://host.docker.internal:9090/v1/chat/completions;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # --------------------
        # OPENAI SDK 
        # --------------------

        location /chat/completions {
            set $auth_token $llm_token;
            auth_request /_auth;
            error_page 401 = @error401;

            proxy_pass http://host.docker.internal:9090/v1/chat/completions;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /completion {
            set $auth_token $llm_token;
            auth_request /_auth;
            error_page 401 = @error401;

            proxy_pass http://host.docker.internal:9090/v1/completion;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # --------------------
        # LLM SDK COMPLETIONS
        # --------------------

        location /llm/completion {
            set $auth_token $llm_token;
            auth_request /_auth;
            error_page 401 = @error401;

            proxy_pass http://host.docker.internal:9090/completion;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # --------------------
        # LLM SDK CHAT COMPLETIONS
        # --------------------

        location /llm/chat/completions {
            set $auth_token $llm_token;
    
            auth_request /_auth;
            error_page 401 = @error401;

            proxy_pass http://host.docker.internal:9090/chat/completions;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        

        # --------------------
        # ERROR HANDLER
        # --------------------

        location @error_handler {
            if ($is_sdk) {
                add_header Content-Type application/json;
                return 404 '{"error":"Not Found"}';
            }
            return 404;
        }

        # --------------------
        # 401 HANDLER (para APIs específicas)
        # --------------------

        location @error401 {
            add_header Content-Type application/json;
            return 401 '{"error":"Unauthorized"}';
        }
    }
}
